<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Pharmacy</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .dashboard-header {
            background: #fff;
            padding: 24px 32px;
            border-bottom: 1px solid #eee;
        }
        .drawer-toggle {
            border: none;
            background: transparent;
            font-size: 2rem;
            color: #0070BB;
            margin-right: 1rem;
        }
        .offcanvas {
            background: #0070BB;
            color: #fff;
        }
        .offcanvas .nav-link {
            color: #fff;
        }
        .offcanvas .nav-link.active {
            background: #005a94;
        }
        .offcanvas .btn {
            color: #0070BB;
        }
        .navbar-custom {
            background: #fff;
            border-bottom: 1px solid #eee;
            padding: 0.75rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 64px;
        }
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            letter-spacing: 1px;
        }
        .navbar-brand .text-primary {
            color: #0070BB !important;
        }
        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .navbar-actions .form-select,
        .navbar-actions .form-control {
            min-width: 140px;
            height: 38px;
        }
        .navbar-actions .icon-btn {
            background: none;
            border: none;
            font-size: 1.25rem;
            margin: 0 0.25rem;
            color: #222;
            position: relative;
        }
        .navbar-actions .icon-btn .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #f44336;
            color: #fff;
            border-radius: 50%;
            font-size: 0.7rem;
            padding: 2px 5px;
        }
        .navbar-actions .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Top Navbar -->
        <nav class="navbar-custom">
            <div class="d-flex align-items-center flex-grow-1">
                <button class="drawer-toggle ms-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarDrawer" aria-controls="sidebarDrawer">
                    <i class="fas fa-bars"></i>
                </button>
                <span class="navbar-brand me-4">Medicare<span class="text-primary">Admin</span></span>
                
            </div>
            <div class="navbar-actions">
                <select class="form-select">
                    <option selected>Select Category</option>
                    <option value="users">Users</option>
                    <option value="products">Products</option>
                    <option value="orders">Orders</option>
                    <option value="prescriptions">Prescriptions</option>
                </select>
                <input type="date" class="form-control" value="2025-10-12" style="width: 140px;">
                <button class="icon-btn" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="badge">1</span>
                </button>
                <button class="icon-btn" title="Search" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
                <button class="icon-btn" title="Mail">
                    <i class="fas fa-envelope"></i>
                </button>
                <img src="https://randomuser.me/api/portraits/women/32.jpg" alt="Profile" class="avatar">
            </div>
        </nav>
        <div class="row">

         
            <!-- Drawer Offcanvas -->
            <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarDrawer" aria-labelledby="sidebarDrawerLabel">
                <div class="offcanvas-header">
                    <h4 class="offcanvas-title" id="sidebarDrawerLabel">Pharmacy Admin</h4>
                    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="nav flex-column">
                        <li class="nav-item mb-2">
                            <a class="nav-link active" href="#">Dashboard</a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link" href="#">Users</a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link" href="#">Products</a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link" href="#">Orders</a>
                        </li>
                        <li class="nav-item mb-2">
                            <a class="nav-link" href="#">Prescriptions</a>
                        </li>
                        <li class="nav-item mt-4">
                            <button id="logoutBtn" class="btn btn-light w-100">Logout</button>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <main class="col-12 px-md-4">
                <div class="row mt-4">
                    
                    <!-- User Stats -->
                    <div class="col-md-3 mb-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-users fa-2x mb-2 text-primary"></i>
                                <h5 class="card-title">Users</h5>
                                <p class="card-text fs-3" id="userCount">--</p>
                            </div>
                        </div>
                    </div>


                    <!-- Product Stats -->
                    <div class="col-md-3 mb-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-pills fa-2x mb-2 text-success"></i>
                                <h5 class="card-title">Products</h5>
                                <p class="card-text fs-3" id="productCount">--</p>
                            </div>
                        </div>
                    </div>


                    <!-- Orders Stats -->
                    <div class="col-md-3 mb-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-shopping-cart fa-2x mb-2 text-warning"></i>
                                <h5 class="card-title">Orders</h5>
                                <p class="card-text fs-3" id="orderCount">--</p>
                            </div>
                        </div>
                    </div>


                    <!-- Prescriptions Stats -->
                    <div class="col-md-3 mb-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-file-medical fa-2x mb-2 text-danger"></i>
                                <h5 class="card-title">Prescriptions</h5>
                                <p class="card-text fs-3" id="prescriptionCount">--</p>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Users Table -->
                <div class="row mt-4">
                  <div class="col-12">
                    <div class="card">
                      <div class="card-header bg-white">
                        <h5 class="mb-0">Users</h5>
                      </div>
                      <div class="card-body p-0">
                        <div class="table-responsive">
                          <table class="table table-striped mb-0">
                            <thead>
                              <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Telephone</th>
                                <th>Gender</th>
                                <th>Profile Picture</th>
                                <th>Address</th>
                                <th>Role</th>
                              </tr>
                            </thead>
                            <tbody id="usersTableBody">
                              <!-- Users will be injected here -->
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Products Table -->
                <div class="row mt-4">
                  <div class="col-12">
                    <div class="card">
                      <div class="card-header bg-white">
                        <h5 class="mb-0">Products</h5>
                      </div>
                      <div class="card-body p-0">
                        <div class="table-responsive">
                          <table class="table table-striped mb-0">
                            <thead>
                              <tr>
                                <th>Product ID</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>imageUrl</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>mfgDate</th>
                                <th>expDate</th>
                                <th>Prescription Required</th>
                              </tr>
                            </thead>
                            <tbody id="productsTableBody">
                              <!-- Products will be injected here -->
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Orders Table -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Recent Orders</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped mb-0">
                                        <thead>
                                            <tr>
                                                <th>Order ID</th>
                                                <th>User</th>
                                                <th>Status</th>
                                                <th>Total</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ordersTableBody">
                                            <!-- Orders will be injected here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prescriptions Table -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Recent Prescriptions</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped mb-0">
                                        <thead>
                                            <tr>
                                                <th>Prescription ID</th>
                                                <th>User</th>
                                                <th>File</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="prescriptionsTableBody">
                                            <!-- Prescriptions will be injected here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/js/all.min.js"></script>
    <script src="../auth/auth.js"></script>
    <script>
        // Example: Fetch stats and recent data from backend
        let allOrders = [];
        let allPrescriptions = [];

        async function fetchDashboardStats() {
            try {
                // Users
                const usersRes = await fetch('http://localhost:5000/api/auth/allusers', { credentials: 'include' });
                const users = await usersRes.json();
                document.getElementById('userCount').textContent = Array.isArray(users) ? users.length : '--';
                const usersTableBody = document.getElementById('usersTableBody');
                usersTableBody.innerHTML = '';
                if (Array.isArray(users)) {
                    users.forEach(user => {
                        const row = usersTableBody.insertRow();
                        row.insertCell().textContent = user.userId || user._id;
                        row.insertCell().textContent = user.fullname;
                        row.insertCell().textContent = user.email;
                        row.insertCell().textContent = user.telno;
                        row.insertCell().textContent = user.gender;
                        const imgCell = row.insertCell();
                        const img = document.createElement('img');
                        img.src = user.profilePic;
                        img.alt = "Profile";
                        img.width = 40;
                        img.height = 40;
                        img.style.borderRadius = "50%";
                        imgCell.appendChild(img);
                        row.insertCell().textContent = user.address;
                        row.insertCell().textContent = user.role;
                    });
                }

                // Products
                const productsRes = await fetch('http://localhost:5000/api/products/allproducts', { credentials: 'include' });
                let products = await productsRes.json();
                // If products is not an array, try to extract array from property
                if (!Array.isArray(products)) {
                    if (Array.isArray(products.products)) {
                        products = products.products;
                    } else {
                        products = [];
                    }
                }
                document.getElementById('productCount').textContent = products.length || '--';
                const productsTableBody = document.getElementById('productsTableBody');
                productsTableBody.innerHTML = '';
                products.forEach(product => {
                    productsTableBody.innerHTML += `
                        <tr>
                    <td>${product.productId}</td>
                    <td>${product.productName}</td>
                    <td>${product.productDescription}</td>
                    <td>${product.category}</td>
                    <td><img src="${product.imageUrl}" alt="Product" width="40" height="40"></td>
                    <td>${product.price}</td>
                    <td>${product.stock}</td>
                    <td>${product.mfgDate ? new Date(product.mfgDate).toLocaleDateString() : ''}</td>
                    <td>${product.expDate ? new Date(product.expDate).toLocaleDateString() : ''}</td>
                    <td>${product.prescriptionRequired ? 'Yes' : 'No'}</td>
                </tr>
                    `;
                });

                // Orders
                const ordersRes = await fetch('http://localhost:5000/api/orders/allorders', { credentials: 'include' });
                let orders = await ordersRes.json();
                if (!Array.isArray(orders)) {
                    if (Array.isArray(orders.orders)) {
                        orders = orders.orders;
                    } else {
                        orders = [];
                    }
                }
                document.getElementById('orderCount').textContent = orders.length || '--';
                const ordersTableBody = document.getElementById('ordersTableBody');
                ordersTableBody.innerHTML = '';
                orders.slice(0, 5).forEach(order => {
                    ordersTableBody.innerHTML += `
                        <tr>
                            <td>${order.orderId || order._id}</td>
                            <td>${order.user?.fullname || order.user || 'N/A'}</td>
                            <td>${order.status || 'N/A'}</td>
                            <td>${order.total || 'N/A'}</td>
                            <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                        </tr>
                    `;
                });

                // Prescriptions
                const prescriptionsRes = await fetch('http://localhost:5000/api/prescription/allprescriptions', { credentials: 'include' });
                let prescriptions = await prescriptionsRes.json();
                if (!Array.isArray(prescriptions)) {
                    if (Array.isArray(prescriptions.prescriptions)) {
                        prescriptions = prescriptions.prescriptions;
                    } else {
                        prescriptions = [];
                    }
                }
                document.getElementById('prescriptionCount').textContent = prescriptions.length || '--';
                const prescriptionsTableBody = document.getElementById('prescriptionsTableBody');
                prescriptionsTableBody.innerHTML = '';
                prescriptions.slice(0, 5).forEach(rx => {
                    prescriptionsTableBody.innerHTML += `
                        <tr>
                            <td>${rx.prescriptionId || rx._id}</td>
                            <td>${rx.user?.fullname || rx.user || 'N/A'}</td>
                            <td><a href="${rx.fileUrl}" target="_blank">View</a></td>
                            <td>${new Date(rx.createdAt).toLocaleDateString()}</td>
                        </tr>
                    `;
                });

                // Save for search
                window.allOrders = orders;
                window.allPrescriptions = prescriptions;
            } catch (err) {
                console.error('Failed to fetch dashboard stats:', err);
                alert('Failed to load dashboard data. Please check the console for details or try again later.');
            }
        }
        fetchDashboardStats();

        // Show search overlay
        document.getElementById('searchBtn').onclick = function() {
            document.getElementById('searchOverlay').style.display = 'flex';
            document.getElementById('searchInput').focus();
        };
        document.getElementById('closeSearch').onclick = function() {
            document.getElementById('searchOverlay').style.display = 'none';
            document.getElementById('searchInput').value = '';
        };

        // Search logic
        document.getElementById('searchForm').onsubmit = function(e) {
            e.preventDefault();
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!query) return;

            // Filter orders
            const filteredOrders = allOrders.filter(order =>
                (order.orderId || order._id || '').toLowerCase().includes(query) ||
                (order.user?.fullname || order.user || '').toLowerCase().includes(query)
            );
            const ordersTableBody = document.getElementById('ordersTableBody');
            ordersTableBody.innerHTML = '';
            filteredOrders.slice(0, 5).forEach(order => {
                ordersTableBody.innerHTML += `
                    <tr>
                        <td>${order.orderId || order._id}</td>
                        <td>${order.user?.fullname || order.user || 'N/A'}</td>
                        <td>${order.status || 'N/A'}</td>
                        <td>${order.total || 'N/A'}</td>
                        <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                    </tr>
                `;
            });

            // Filter prescriptions
            const filteredPrescriptions = allPrescriptions.filter(rx =>
                (rx.prescriptionId || rx._id || '').toLowerCase().includes(query) ||
                (rx.user?.fullname || rx.user || '').toLowerCase().includes(query)
            );
            const prescriptionsTableBody = document.getElementById('prescriptionsTableBody');
            prescriptionsTableBody.innerHTML = '';
            filteredPrescriptions.slice(0, 5).forEach(rx => {
                prescriptionsTableBody.innerHTML += `
                    <tr>
                        <td>${rx.prescriptionId || rx._id}</td>
                        <td>${rx.user?.fullname || rx.user || 'N/A'}</td>
                        <td><a href="${rx.fileUrl}" target="_blank">View</a></td>
                        <td>${new Date(rx.createdAt).toLocaleDateString()}</td>
                    </tr>
                `;
            });

            document.getElementById('searchOverlay').style.display = 'none';
            document.getElementById('searchInput').value = '';
        };
    </script>

    <!-- Search Overlay -->
    <div id="searchOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1050; align-items:center; justify-content:center;">
        <form id="searchForm" style="background:#fff; padding:2rem; border-radius:16px; box-shadow:0 2px 16px rgba(0,0,0,0.15); min-width:300px; display:flex; flex-direction:column; gap:1rem;">
            <label for="searchInput" class="fw-bold">Search</label>
            <input type="text" id="searchInput" class="form-control" placeholder="Type name or ID..." autofocus>
            <div class="d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-primary">Search</button>
                <button type="button" class="btn btn-secondary" id="closeSearch">Close</button>
            </div>
        </form>
    </div>
</body>
</html>